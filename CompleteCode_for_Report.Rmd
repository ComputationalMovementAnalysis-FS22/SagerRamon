---
title: "CompleteCode_for_Report"
output: html_document
date: "`r Sys.Date()`"
---

```{r, warning=F, message=F}
rm(list=ls())
```

# Libraries

```{r, warning=F, message=F}
library(ComputationalMovementAnalysisData)  # Wild Boar Data 
library(tidyverse)                          # dplyr, ggplot, etc.
library(sf)                                 # spatial data operations
library(tmap)                               # thematic maps for spatial vector data 
library(terra)                              # spatial raster and vector data operations
library(gridExtra)                          # functions to work with grids and their visualizations
library(data.table)                         # functions for easy handling of data frames
library(lubridate)                          # for easy handling of Datetimes
library(ggpubr)                             # for ggplot customizations

```


```{r, warning=F, message=F}
ws <- wildschwein_BE                        # complete Dataset of Wild Boar
metadata <- wildschwein_metadata            # Wild Boar metadata

underl_map <- terra::rast("pk100_BE.tif")   # underlay raster map of the region
```


```{r}
names(ws)                                   # all column names

# removing some unsused columns
ws <- ws %>% subset(select = - c(day, CollarID, moonilumination))

n_distinct(ws$TierID)                       # 19 Wild Boar
```


```{r}
# Adding "timelag" column - time between each sampling occasion
ws <- ws %>% 
  group_by(TierID) %>% 
  mutate(timelag = as.integer(difftime(lead(DatetimeUTC), DatetimeUTC, units = "secs"))) %>% 
  ungroup()

summary(ws$timelag)
# 19 NA's because of 19 distinct ID's
```





# EDA (Exploratory Data Analysis)

## Exploring Sampling Intervals and timing of samplings for each Wild Boar

```{r}
ws$TierID <- as.factor(ws$TierID)

p1 <- ws %>% ggplot(aes(x = DatetimeUTC, y = TierID, colour = TierID)) +
  geom_point(show.legend = F)

p1  
```


```{r}
range(ws$timelag, na.rm = T)    # range of values in timelag
nrow(ws)                        # number of observations

# Filtering Rows with unreasonable values
ws_range <- ws %>% 
  filter(timelag >= 0 & timelag < 30000)
  

range(ws_range$timelag, na.rm = T)
nrow(ws_range)

nrow(ws) - nrow(ws_range)       # 47 values removed
```


### Histograms of sampling interval distribution
```{r, warning=FALSE}
ws_range %>% 
  ggplot(aes(x = timelag)) +
  geom_histogram(binwidth = 60) +
  scale_y_log10()
```


```{r, warning=FALSE}
# filtered for intervals between 0  and 2000 seconds 
ws_range2 <- ws_range %>% filter(timelag >= 0 & timelag < 2000)

ws_range2 %>% 
  ggplot(aes(x = timelag)) +
  geom_histogram(binwidth = 1) +
  scale_y_log10()    # logarithmic for better visualization of sampling intervals counts
```
-> most sampling intervals are between 10 & 20 minutes


```{r}
# Count of 60 second sampling intervals
ws_60s <- ws_range %>% filter(timelag >= 40 & timelag < 70)

ws_60s %>% 
  ggplot(aes(x = timelag)) +
  geom_histogram(binwidth = 1) +
  scale_y_log10()

```
-> around 30000 sampling intervals are within 1 minute

```{r}
ws_60s <- ws_60s %>% filter(DatetimeUTC > "2015-01-01" & DatetimeUTC < "2016-01-01")

p3 <- ws_60s %>% ggplot(aes(x = DatetimeUTC, y = TierID, colour = TierID)) +
  geom_point(show.legend = F)

p3

```
-> Animal ID's c(10, 22, 36, 40, 48) have sampling intervals of one minute in overlapping times in the year 2015

```{r}
# Names of the animals we are interested in, based on their 60 seconds intervals in sampling
ws_names <- unique(ws_60s$TierName)
```



## Pre-Analysis of Location

```{r}
sf_60s <- st_as_sf(ws_60s, coords = c("E","N"), crs = 2056)

sf_60s_grouped <- group_by(sf_60s, TierID)
```

```{r}
sf_60s_smry <- summarise(sf_60s_grouped)
mcp <- st_convex_hull(sf_60s_smry)
```

```{r}
ggplot(mcp, ) + 
    aes(fill = TierID, alpha = 0.5) +
    geom_sf() +
    coord_sf(datum = sf::st_crs(2056))
```
-> Overlapping convex-hulls, except Wild Boar with ID 48. Also, sizes apparently differ among sexes (40 & 48 are males).


## Transforming to SF object and adding Sex to data set from metadata
```{r}
ws <- merge(ws, metadata[, c("TierID","Sex")], by = "TierID")

ws_sf <- st_as_sf(ws,
                coords = c("E", "N"), 
                crs = 2056)

ws_sf$TierID <- as.factor(ws_sf$TierID)
ws_grp <- ws_sf %>% group_by(TierID)
```


# Plotting Convex Hull's of Males and females separately
```{r}
# ws_grp -> is a grouped sf object containing all individuals
# m_grp -> just males
# f_grp -> just females

m_grp <- ws_grp %>% filter(Sex == "m")
f_grp <- ws_grp %>% filter(Sex == "f")

m_smry <- summarise(m_grp)
f_smry <- summarise(f_grp)

m_mcp <- st_convex_hull(m_smry)
f_mcp <- st_convex_hull(f_smry)
```


```{r}
tmap_mode("view") # open in viewer for interactive map

#males
mcp_males <- tm_shape(underl_map) + 
              tm_rgb() +
              tm_shape(m_mcp) +
              tm_polygons("TierID", alpha = 0.5, border.col = "red", legend.show = FALSE)

mcp_males
```


```{r}
#females
mcp_females <- tm_shape(underl_map) + 
                tm_rgb() +
                tm_shape(f_mcp) +
                tm_polygons("TierID", alpha = 0.5, border.col = "red", legend.show = FALSE)

mcp_females
```
-> females very overlapping, however, time of sampling differs
-> males seem to have larger mcp's
-> all mcp's are covering the main forest patch near the lake













# Territorial Analysis


## Research Question:
Can we identify (core) territories of individual Wild Boar in their resting/sleeping sites and feeding grounds?

## Hypothesis
We expect that we can at least to some extent identify core territories. Given that, we further expect that these territories differ in size between the resting sites (the forest patch) and the feeding grounds (agricultural sites), and among sexes.


```{r}
# removing all the data form memory
rm(list=ls())
```

```{r}
# reloading the Wild Boar data
ws <- wildschwein_BE                        # complete Dataset of Wild Boar
metadata <- wildschwein_metadata            # Wild Boar metadata

underl_map <- terra::rast("pk100_BE.tif")   # underlay raster map of the region
```



## Data Preparation
```{r}
# adding Sex and Study_area from metadata to the data set, removing unused columns
ws <- merge(ws, metadata[, c("TierID","Sex")], by = "TierID")
ws <- merge(ws, metadata[, c("TierID","Study_area")], by = "TierID")
ws <- ws %>% subset(select = - c(CollarID, day, moonilumination))

ws_fin <- ws %>% 
  filter(Study_area == "Bern")
# apparently, complete data set already only containing animals from the Bernese study area

# removing this variable and column "study_area" again
rm(ws_fin)
ws <- ws %>%  subset(select = - c(Study_area))
```


```{r}
# Focusing only on these 5 individuals having a sampling interval of 60 seconds
ws <- ws %>% filter(TierID %in% c(10, 22, 36, 40, 48)) 

```


```{r}
ws_sf <- st_as_sf(ws,
                coords = c("E", "N"), 
                crs = 2056)

# ws_sf_nonfactor <- ws_sf
ws_sf$TierID <- as.factor(ws_sf$TierID)
```







## Territorial Analysis using the "aggregate" function 

### Function to produce an occurence plot using a grid structure with aggregate. 

Applicable to any Wild Boar in the Data set and can also handle multiple (or all) animals as inputs, producing a list of plots. After applying the function, these can either be arranged to be viewed and compared together, or each plot can separately be extracted from the plot list.
```{r}
grid_agg_plots <- function(data, underl_map, Cellsize){
  
  # get ID's in input data and produce an empty list
  id_list <- unique(data$TierID)
  plot_list <- vector("list", length(id_list))
  
  data <- group_by(data, TierID)
  
  for (i in seq(1,length(id_list))){
    # extracting data of the animal with certain animal ID:
    ws_temp <- filter(data, TierID == id_list[i])
    
    # constructing the Grid by the outermost points of the animal in question
    grid_area <- st_make_grid(ws_temp, square = FALSE, cellsize = Cellsize, crs = 2056) %>% st_as_sf()
    
    # aggregating the gps points to each grid cell
    grid_agg <- aggregate(x = ws_temp, by = grid_area, FUN = length) %>% select(TierID)
    
    # producing the plot
    p <-  tm_shape(underl_map) +
                      tm_rgb() +
                      tm_shape(grid_agg) +
                      tm_polygons("TierID", alpha = 0.7, style="cont", legend.show = TRUE) +
                      tm_layout(legend.outside = TRUE)
      
    # creating variable & append to plot list
    var_name <- paste("P", id_list[i], sep = "")
    
    # appending to plot list
    plot_list[[i]] <- assign(var_name, p)
    
  }
  return(plot_list)
}
```


### running the function on all individuals with 60 second sampling interval in one plot
```{r}
plots <- grid_agg_plots(ws_sf, underl_map, 150)
```


### Plot all individuals with 60 second sampling interval in one plot
```{r, message=FALSE, warning=FALSE, fig.height=16, fig.width=14}
# may need to adjust size of plot

tmap_mode("plot")           # mode to view plot in plot instead of viewer

Arranged_plots <- tmap_arrange(plots, ncol = 2)   # arranging the plots next to each other
Arranged_plots
```
-> plot representing absolute number of gps points in each grid cell for each animal
-> plots are in order:    first plot (top left)   = animal with ID 10
                          second plot (top right) = animal with ID 22
                          and so on... couldn't figure out how to name the plots


### plot animals with ID's: 22 (Miriam) & 36 (Olga) (both females)
```{r, message=FALSE, warning=FALSE, fig.height=10, fig.width=8}
ws_females    <- ws_sf %>% filter(TierID %in% c(22,36))
plots_females <- grid_agg_plots(ws_females, underl_map, 150)
arr_females   <- tmap_arrange(plots_females, ncol = 1)
arr_females
```


### plot animals with ID's: 40 (Franz) & 36 (Amos) (both males)
```{r, message=FALSE, warning=FALSE, fig.height=10, fig.width=8}
ws_males      <- ws_sf %>% filter(TierID %in% c(40,48))
plots_males   <- grid_agg_plots(ws_males  , underl_map, 150)
arr_males     <- tmap_arrange(plots_males  , ncol = 1)
arr_males
```






## Territorial Analysis using the "st_join" function -> keeping much more information and seems to be "the way to go" 

### Function to produce an occurence plot using a grid structure with st_join. 

Big advantage of this method compared to using "aggregate", is that we can recover a lot of information that would get lost in the aggregate function. Here, we did it in a way so we can keep information about Animal ID. Later, in the section about "Recurrence", we are able to keep information about datetime and additional logical information to construct recurrences to a specific cell in the grid using the st_join method.

Applicable to any Wild Boar in the Data set and can also handle multiple (or all) animals as inputs, producing a list of plots. After applying the function, these can either be arranged to be viewed and compared together, or each plot can separately be extracted from the plot list.
```{r}

grid_join_plots <- function(data, underl_map, Cellsize){

  # get ID's in input data and produce an empty list
  id_list <- unique(data$TierID)
  plot_list <- vector("list", length(id_list))
  
  data <- group_by(data, TierID)
  
  for (i in seq(1,length(id_list))){
    
    # extracting data of the animal with certain animal ID:
    ws_temp <- filter(data, TierID == id_list[i]) %>% select(DatetimeUTC, TierID)
    
    # constructing the Grid by the outermost points of the animal in question
    grid_area <- st_make_grid(ws_temp, square = FALSE, cellsize = Cellsize, crs = 2056) %>% st_as_sf()
    
    # Adding unique ID to each cell in the grid
    grid_area <- grid_area %>% mutate(ID = row_number())
    
    # join all data points to each grid cell
    grid_agg <- st_join(ws_temp, grid_area, left = FALSE)
    
    # get number of occurrences in each grid cell
    by_cell <- grid_agg %>% group_by(ID,TierID) %>% summarise(n = n())
    
    # join information in each grid cell to the grid by joining the cell ID's
    new_agg <- st_join(grid_area, by_cell)
    
    # produce individual plot 
    p <-  tm_shape(underl_map) +
                      tm_rgb() +
                      tm_shape(new_agg) +
                      tm_polygons("n", alpha = 0.8, style = "cont", legend.show = TRUE) +
                      tm_layout(legend.outside = TRUE)

    # creating variable & append to plot list
    var_name <- paste("P", id_list[i], sep = "")

    # appending to plot list
    plot_list[[i]] <- assign(var_name, p)

  }
  return(plot_list)
  # return(grid_agg)
}
```


### running the function on all individuals with 60 second sampling interval in one plot
```{r}
plots <- grid_join_plots(ws_sf, underl_map, 150)
```


### Plot all individuals with 60 second sampling interval in one plot
```{r, message=FALSE, warning=FALSE, fig.height=16, fig.width=14}
# may need to adjust size of plot

tmap_mode("plot")           # mode to view plot in plot instead of viewer

Arranged_plots <- tmap_arrange(plots, ncol = 2)   # arranging the plots next to each other
Arranged_plots
```
-> plot representing absolute number of gps points in each grid cell for each animal
-> plots are in order:    first plot (top left)   = animal with ID 10
                          second plot (top right) = animal with ID 22
                          and so on... couldn't figure out how to name the plots








## Analysis of recurrences to each grid cell by an individual wild boar.

This is giving us another information about the territory of an individual, as we can see which cells were repeatedly visited and seem to represent the main sleeping (in resting territories) and feeding (in the feeding grounds) territories of the wild boar.


















































